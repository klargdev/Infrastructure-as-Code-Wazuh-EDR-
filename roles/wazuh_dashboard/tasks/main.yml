
# --- Ensure required packages are installed ---
- name: Install required system packages
  apt:
    name:
      - debhelper
      - tar
      - curl
      - libcap2-bin
      - gnupg
      - apt-transport-https
    state: present
    update_cache: yes
  tags: [install, dashboard]

# --- Add Wazuh GPG key using official keyring method ---
- name: Download and import Wazuh GPG key
  shell: |
    curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH | \
      gpg --no-default-keyring --keyring gnupg-ring:/usr/share/keyrings/wazuh.gpg --import && \
      chmod 644 /usr/share/keyrings/wazuh.gpg
  args:
    creates: /usr/share/keyrings/wazuh.gpg
  tags: [install, dashboard]

# --- Add Wazuh repository using signed-by ---
- name: Add Wazuh Dashboard repository (official method)
  copy:
    dest: /etc/apt/sources.list.d/wazuh.list
    content: |
      deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main
    owner: root
    group: root
    mode: '0644'
  tags: [install, dashboard]

- name: Update apt cache
  apt:
    update_cache: yes
  tags: [install, dashboard]

# --- Install Wazuh Dashboard ---
- name: Install Wazuh Dashboard
  apt:
    name: wazuh-dashboard
    state: present
    update_cache: yes
  tags: [install, dashboard]

# --- Certificate Deployment (official method) ---
- name: Ensure wazuh-certificates.tar is present
  stat:
    path: /tmp/wazuh-certificates.tar
  register: dashboard_cert_tar
  tags: [certs, dashboard]

- name: Fail if wazuh-certificates.tar is missing
  fail:
    msg: "wazuh-certificates.tar is missing in /tmp. Please copy it from the certificate generation step."
  when: not dashboard_cert_tar.stat.exists
  tags: [certs, dashboard]

- name: Create certificates directory for dashboard
  file:
    path: /etc/wazuh-dashboard/certs
    state: directory
    owner: wazuh-dashboard
    group: wazuh-dashboard
    mode: '0755'
  tags: [certs, dashboard]

- name: Extract and move dashboard certificates (official method)
  shell: |
    tar -xf /tmp/wazuh-certificates.tar -C /etc/wazuh-dashboard/certs/ ./dashboard.pem ./dashboard-key.pem ./root-ca.pem || true
    mv -n /etc/wazuh-dashboard/certs/dashboard.pem /etc/wazuh-dashboard/certs/dashboard.pem
    mv -n /etc/wazuh-dashboard/certs/dashboard-key.pem /etc/wazuh-dashboard/certs/dashboard-key.pem
    chmod 500 /etc/wazuh-dashboard/certs
    chmod 400 /etc/wazuh-dashboard/certs/*
    chown -R wazuh-dashboard:wazuh-dashboard /etc/wazuh-dashboard/certs
  args:
    executable: /bin/bash
  tags: [certs, dashboard]

# --- Dashboard Configuration ---
- name: Deploy Wazuh Dashboard configuration
  template:
    src: opensearch_dashboards.yml.j2
    dest: /etc/wazuh-dashboard/opensearch_dashboards.yml
    owner: wazuh-dashboard
    group: wazuh-dashboard
    mode: '0640'
  notify: restart wazuh dashboard
  tags: [config, dashboard]

# --- Start and enable Wazuh Dashboard service ---
- name: Enable and start Wazuh Dashboard service
  systemd:
    name: wazuh-dashboard
    enabled: yes
    state: started
    daemon_reload: yes
  tags: [service, dashboard]

# --- Wait for Wazuh Dashboard to be ready ---
- name: Wait for Wazuh Dashboard to be ready
  wait_for:
    port: 5601
    host: 127.0.0.1
    timeout: 120
  tags: [service, dashboard]

# --- Optionally disable Wazuh repo after install for security ---
- name: Disable Wazuh repository after install (recommended)
  lineinfile:
    path: /etc/apt/sources.list.d/wazuh.list
    regexp: '^deb '
    line: '#deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main'
    state: present
  tags: [install, dashboard]

- name: Set proper permissions for certificates
  file:
    path: /etc/wazuh-dashboard/certs
    owner: wazuh-dashboard
    group: wazuh-dashboard
    mode: '0755'
    recurse: yes
  tags: [config, dashboard]

- name: Create Wazuh Dashboard keystore
  command: /usr/share/wazuh-dashboard/bin/opensearch-dashboards-keystore create
  args:
    creates: /etc/wazuh-dashboard/opensearch_dashboards.keystore
  tags: [config, dashboard]

- name: Add Wazuh Indexer username to keystore
  shell: echo admin | /usr/share/wazuh-dashboard/bin/opensearch-dashboards-keystore add opensearch.username --stdin --force
  tags: [config, dashboard]

- name: Add Wazuh Indexer password to keystore
  shell: echo admin | /usr/share/wazuh-dashboard/bin/opensearch-dashboards-keystore add opensearch.password --stdin --force
  tags: [config, dashboard]

- name: Enable and start Wazuh Dashboard service
  systemd:
    name: wazuh-dashboard
    enabled: yes
    state: started
    daemon_reload: yes
  tags: [service, dashboard]

- name: Wait for Wazuh Dashboard to be ready
  wait_for:
    port: 5601
    host: 127.0.0.1
    timeout: 120
  tags: [service, dashboard]

- name: Install Wazuh Dashboard plugin
  command: /usr/share/wazuh-dashboard/bin/opensearch-dashboards-plugin install https://packages.wazuh.com/4.x/ui/dashboard/wazuh-dashboard-plugin-4.12.0.zip
  args:
    creates: /usr/share/wazuh-dashboard/plugins/wazuh
  tags: [config, dashboard]
  ignore_errors: yes

- name: Restart Wazuh Dashboard after plugin installation
  systemd:
    name: wazuh-dashboard
    state: restarted
  when: ansible_check_mode is not defined
  tags: [service, dashboard]
